<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="切面的应用">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring07-切面的应用">
<meta property="og:url" content="http://example.com/2021/07/11/Spring07-%E5%88%87%E9%9D%A2%E7%9A%84%E5%BA%94%E7%94%A8/index.html">
<meta property="og:site_name" content="24khandsome&#39;s Blog">
<meta property="og:description" content="切面的应用">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-07-11T13:00:00.000Z">
<meta property="article:modified_time" content="2021-08-05T15:48:23.752Z">
<meta property="article:author" content="24khandsome">
<meta property="article:tag" content="源码">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="AOP">
<meta property="article:tag" content="切面应用">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2021/07/11/Spring07-%E5%88%87%E9%9D%A2%E7%9A%84%E5%BA%94%E7%94%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Spring07-切面的应用 | 24khandsome's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">24khandsome's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">24khandsome's Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/11/Spring07-%E5%88%87%E9%9D%A2%E7%9A%84%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="24khandsome">
      <meta itemprop="description" content="24khandsome's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="24khandsome's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring07-切面的应用
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-11 21:00:00" itemprop="dateCreated datePublished" datetime="2021-07-11T21:00:00+08:00">2021-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-08-05 23:48:23" itemprop="dateModified" datetime="2021-08-05T23:48:23+08:00">2021-08-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
            </span>

          
            <div class="post-description">切面的应用</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Spring切面应用"><a href="#Spring切面应用" class="headerlink" title="Spring切面应用"></a>Spring切面应用</h1><h2 id="多数据源插件-后续补充"><a href="#多数据源插件-后续补充" class="headerlink" title="多数据源插件(后续补充)"></a>多数据源插件(后续补充)</h2><h2 id="分布式锁插件"><a href="#分布式锁插件" class="headerlink" title="分布式锁插件"></a>分布式锁插件</h2><p>思路：</p>
<p>1、生命一个注解</p>
<p>2、切面环绕通知切这个注解</p>
<p>3、使用redis做分布式锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(ElementType.METHOD)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> DistributedLock &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 锁过期时间 1小时</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">expireMillis</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> 3600000L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 锁尝试时间 1分钟</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">timeoutMillis</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> 60000L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 锁的主key</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">String <span class="hljs-title">mainKey</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> &quot;&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 锁的spEL格式Key</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">String <span class="hljs-title">spelKey</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> &quot;&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 无法获得锁时，是否跳过</span><br><span class="hljs-comment">     * true: 跳过</span><br><span class="hljs-comment">     * false: 默认报错</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">skipWhenCanNotGetLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">false</span></span>;<br>&#125;<br><br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Order(2)</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DistributedLockAspect</span> </span>&#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedisDistributedLock redisDistributedLock;<br><br><br>    String COM_LOCK = <span class="hljs-string">&quot;com:lock:&quot;</span>;<br><br><br>    String COM_LOCK_FEIGN_OAUTH_TOKEN = COM_LOCK + <span class="hljs-string">&quot;token:feign_oauth:&quot;</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 所有被<span class="hljs-doctag">@DistributedLock</span>注解的方法，使用分布式锁，限制一个时间内只有一个任务在执行</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> point</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> distributedLock</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Throwable</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Around(&quot;@annotation(distributedLock)&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">around</span><span class="hljs-params">(ProceedingJoinPoint point, DistributedLock distributedLock)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        String key = generateLockKey(point, distributedLock.mainKey(), distributedLock.spelKey());<br><br>        <span class="hljs-comment">// 判断无法获得锁的时候，是否可以跳过程序</span><br>        <span class="hljs-keyword">if</span> (distributedLock.skipWhenCanNotGetLock() &amp;&amp; redisDistributedLock.isExist(key)) &#123;<br>            log.warn(<span class="hljs-string">&quot;DistributedLock 无法获得锁: &#123;&#125;, 锁已存在, 程序将跳过执行&quot;</span>, key);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">boolean</span> tryLock = <span class="hljs-keyword">false</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            tryLock = redisDistributedLock.tryLock(key, distributedLock.expireMillis(),<br>                    distributedLock.timeoutMillis());<br>            <span class="hljs-keyword">if</span> (!tryLock) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> DistributedLockConcurrentException(<span class="hljs-string">&quot;@DistributedLock获取锁失败，已有相同任务在运行&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">return</span> point.proceed();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (tryLock) &#123;<br>                redisDistributedLock.unLock(key);<br>            &#125;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成分布式锁的key</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> point</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">generateLockKey</span><span class="hljs-params">(ProceedingJoinPoint point, String mainKey, String spelKey)</span> </span>&#123;<br>        MethodSignature signature = AopUtil.getMethodSignature(point);<br><br>        String targrtMainKey;<br>        <span class="hljs-keyword">if</span> (StrUtil.isBlank(mainKey)) &#123;<br>            String className = AopUtil.getClassName(point);<br>            String methodName = signature.getName();<br>            targrtMainKey = className + <span class="hljs-string">&quot;_&quot;</span> + methodName;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            targrtMainKey = mainKey;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (StrUtil.isBlank(spelKey)) &#123;<br>            <span class="hljs-keyword">return</span> COM_LOCK + targrtMainKey;<br>        &#125;<br><br>        Method method = signature.getMethod();<br>        Object[] args = point.getArgs();<br>        String targetSpelKey = AopUtil.parseSpelKey(spelKey, method, args, String.class);<br><br>        <span class="hljs-keyword">return</span> COM_LOCK + targrtMainKey + <span class="hljs-string">&quot;_&quot;</span> + targetSpelKey;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Validated</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisDistributedLock</span> </span>&#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 尝试获得获得锁</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key           key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> expireMillis  锁超时时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> timeoutMillis 获取锁最大等待时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">(String key, <span class="hljs-keyword">long</span> expireMillis, <span class="hljs-keyword">long</span> timeoutMillis)</span> </span>&#123;<br>        String macThreadId = getThreadSignature();<br>        <span class="hljs-keyword">return</span> tryLock(key, macThreadId, expireMillis, timeoutMillis);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 尝试获得获得锁</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key          key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> expireMillis 锁超时时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> tryLockCnt   获取锁尝试次数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLockCnt</span><span class="hljs-params">(String key, <span class="hljs-meta">@Min(1)</span> <span class="hljs-keyword">int</span> tryLockCnt, <span class="hljs-keyword">long</span> expireMillis)</span> </span>&#123;<br>        String macThreadId = getThreadSignature();<br>        <span class="hljs-keyword">return</span> tryLockCnt(key, macThreadId, tryLockCnt, expireMillis);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 释放锁</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key 锁的key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">unLock</span><span class="hljs-params">(String key)</span> </span>&#123;<br>        String macThreadId = getThreadSignature();<br>        <span class="hljs-keyword">return</span> unLock(key, macThreadId);<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 延迟释放锁</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key          锁的key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> expireSecond expireSecond</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">unLockLater</span><span class="hljs-params">(String key, <span class="hljs-keyword">long</span> expireSecond)</span> </span>&#123;<br>        String signature = getThreadSignature();<br>        <span class="hljs-keyword">return</span> unLockLater(key, signature, expireSecond);<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 机器锁</span><br><span class="hljs-comment">     * 锁住机器的MAC地址</span><br><span class="hljs-comment">     * 只允许同一台机器执行</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key          锁的key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> expireMillis 锁的时间，单位秒，null表示锁1天</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryMacLock</span><span class="hljs-params">(String key, <span class="hljs-keyword">long</span> expireMillis, <span class="hljs-keyword">long</span> timeoutMillis)</span> </span>&#123;<br>        <span class="hljs-comment">//String mac = ServerRunTimeUtil.getMac();</span><br>        <span class="hljs-comment">//TODO是否可重写</span><br>        String mac = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">return</span> tryLock(key, mac, expireMillis, timeoutMillis);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 尝试获得获得机器锁</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key          key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> expireMillis 锁超时时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> tryLockCnt   获取锁尝试次数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryMacLockCnt</span><span class="hljs-params">(String key, <span class="hljs-meta">@Min(1)</span> <span class="hljs-keyword">int</span> tryLockCnt, <span class="hljs-keyword">long</span> expireMillis)</span> </span>&#123;<br>        <span class="hljs-comment">//String mac = ServerRunTimeUtil.getMac();</span><br>        <span class="hljs-comment">//TODO是否可重写</span><br>        String mac = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">return</span> tryLockCnt(key, mac, tryLockCnt, expireMillis);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 释放机器锁</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key 锁的key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">unMacLock</span><span class="hljs-params">(String key)</span> </span>&#123;<br>        <span class="hljs-comment">//String mac = ServerRunTimeUtil.getMac();</span><br>        <span class="hljs-comment">//TODO是否可重写</span><br>        String mac = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">return</span> unLock(key, mac);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 判断锁是否存在</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isExist</span><span class="hljs-params">(String key)</span> </span>&#123;<br>        String lockKey = generateKey(key);<br>        <span class="hljs-keyword">return</span> redisTemplate.hasKey(lockKey);<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 分布式锁加锁</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> requesterId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> expireMillis</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> timeoutMillis</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLock</span><span class="hljs-params">(String key, String requesterId, <span class="hljs-keyword">long</span> expireMillis, <span class="hljs-keyword">long</span> timeoutMillis)</span> </span>&#123;<br>        String lockKey = generateKey(key);<br>        <span class="hljs-comment">//return eadisSyncCommands.lock(lockKey, requesterId, expireMillis, timeoutMillis);</span><br>        <span class="hljs-comment">// 利用lambda表达式</span><br>        <span class="hljs-keyword">return</span> (Boolean) redisTemplate.execute(<span class="hljs-keyword">new</span> RedisCallback&lt;Object&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">doInRedis</span><span class="hljs-params">(RedisConnection redisConnection)</span> <span class="hljs-keyword">throws</span> DataAccessException </span>&#123;<br>                <span class="hljs-keyword">long</span> expireAt = System.currentTimeMillis() + expireMillis + <span class="hljs-number">1</span>;<br>                Boolean acquire = redisConnection.setNX(lockKey.getBytes(), String.valueOf(expireAt).getBytes());<br>                <span class="hljs-keyword">if</span> (acquire) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">byte</span>[] value = redisConnection.get(lockKey.getBytes());<br>                    <span class="hljs-keyword">if</span> (Objects.nonNull(value) &amp;&amp; value.length &gt; <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-keyword">long</span> expireTime = Long.parseLong(<span class="hljs-keyword">new</span> String(value));<br>                        <span class="hljs-keyword">if</span> (expireTime &lt; System.currentTimeMillis()) &#123;<br>                            <span class="hljs-comment">// 如果锁已经过期</span><br>                            <span class="hljs-keyword">byte</span>[] oldValue = redisConnection.getSet(lockKey.getBytes(), String.valueOf(System.currentTimeMillis() + expireMillis + <span class="hljs-number">1</span>).getBytes());<br>                            <span class="hljs-comment">// 防止死锁</span><br>                            <span class="hljs-keyword">return</span> Long.parseLong(<span class="hljs-keyword">new</span> String(oldValue)) &lt; System.currentTimeMillis();<br>                        &#125;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 尝试获得获得锁</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key          key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> requesterId  锁标识</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> tryLockCnt   尝试获取锁的次数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> expireMillis 锁超时时间</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">tryLockCnt</span><span class="hljs-params">(String key, String requesterId, <span class="hljs-meta">@Min(1)</span> <span class="hljs-keyword">int</span> tryLockCnt, <span class="hljs-keyword">long</span> expireMillis)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (i &lt; tryLockCnt) &#123;<br>            <span class="hljs-keyword">boolean</span> tryLock = tryLock(key, requesterId, expireMillis, <span class="hljs-number">0L</span>);<br>            <span class="hljs-keyword">if</span> (tryLock) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125;<br>            i++;<br>            <span class="hljs-keyword">if</span> (i == tryLockCnt) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">100L</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                log.warn(<span class="hljs-string">&quot;获得分布式锁时，尝试睡眠失败&quot;</span>, e);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 分布式锁释放</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> requesterId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">unLock</span><span class="hljs-params">(String key, String requesterId)</span> </span>&#123;<br>        String lockKey = generateKey(key);<br>        <span class="hljs-keyword">return</span> redisTemplate.delete(lockKey);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 分布式锁延迟释放</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> requesterId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> expireSecond</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">unLockLater</span><span class="hljs-params">(String key, String requesterId, <span class="hljs-keyword">long</span> expireSecond)</span> </span>&#123;<br>        String lockKey = generateKey(key);<br>        Boolean expire = redisTemplate.expire(lockKey, expireSecond, TimeUnit.SECONDS);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span> == expire ? <span class="hljs-keyword">false</span> : expire;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获得线程标识</span><br><span class="hljs-comment">     * 只有线程标识相同，才能解锁</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getThreadSignature</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">//String mac = ServerRunTimeUtil.getMac();</span><br>        <span class="hljs-comment">//TODO是否可重写</span><br>        String mac = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-comment">//String runtimeMxBeanName = ServerRunTimeUtil.getRuntimeMxBeanName();</span><br>        <span class="hljs-comment">//TODO 是否可重写</span><br>        String runtimeMxBeanName = <span class="hljs-string">&quot;&quot;</span>;<br>        String currentThreadId = String.valueOf(Thread.currentThread().getId());<br>        <span class="hljs-keyword">return</span> mac + <span class="hljs-string">&quot;_&quot;</span> + runtimeMxBeanName + <span class="hljs-string">&quot;_&quot;</span> + currentThreadId;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成锁的key</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">generateKey</span><span class="hljs-params">(String key)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> key;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AopUtil</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class <span class="hljs-title">getClassFromJoinPoint</span><span class="hljs-params">(ProceedingJoinPoint point)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> point.getTarget().getClass();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Method <span class="hljs-title">getMethodFromJoinPoint</span><span class="hljs-params">(ProceedingJoinPoint point)</span> </span>&#123;<br>        Signature signature = point.getSignature();<br>        MethodSignature methodSignature = (MethodSignature) signature;<br>        <span class="hljs-keyword">return</span> methodSignature.getMethod();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object[] getMethodArgsFromJoinPoint(ProceedingJoinPoint point) &#123;<br>        <span class="hljs-keyword">return</span> point.getArgs();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获得MethodSignature</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> point</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MethodSignature <span class="hljs-title">getMethodSignature</span><span class="hljs-params">(ProceedingJoinPoint point)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> == point) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        Signature pointSignature = point.getSignature();<br>        <span class="hljs-keyword">if</span> (!(pointSignature <span class="hljs-keyword">instanceof</span> MethodSignature)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> (MethodSignature) pointSignature;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获得Class 全路径</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> point</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getClassName</span><span class="hljs-params">(ProceedingJoinPoint point)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> == point) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>        Object target = point.getTarget();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> == target) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>        Class&lt;?&gt; aClass = target.getClass();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> == aClass) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> aClass.getName();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取spEL表达式代表的值</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> method</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">parseSpelKey</span><span class="hljs-params">(String key, Method method, Object[] args, Class&lt;T&gt; clazz)</span> </span>&#123;<br><br>        <span class="hljs-keyword">if</span> (StrUtil.isEmpty(key)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//获取被拦截方法参数名列表(使用Spring支持类库)</span><br>        LocalVariableTableParameterNameDiscoverer u = <span class="hljs-keyword">new</span> LocalVariableTableParameterNameDiscoverer();<br>        String[] paraNameArr = u.getParameterNames(method);<br><br>        <span class="hljs-comment">//使用SPEL进行key的解析</span><br>        ExpressionParser parser = <span class="hljs-keyword">new</span> SpelExpressionParser();<br>        <span class="hljs-comment">//SPEL上下文</span><br>        StandardEvaluationContext context = <span class="hljs-keyword">new</span> StandardEvaluationContext();<br>        <span class="hljs-comment">//把方法参数放入SPEL上下文中</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; paraNameArr.length; i++) &#123;<br>            context.setVariable(paraNameArr[i], args[i]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> parser.parseExpression(key).getValue(context, clazz);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">	<span class="hljs-meta">@Transactional</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@DistributedLock(spelKey = &quot;#accountId&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pay</span><span class="hljs-params">(String accountId, <span class="hljs-keyword">double</span> money)</span> </span>&#123;<br>        <span class="hljs-comment">//查询余额</span><br>        <span class="hljs-keyword">double</span> blance = accountInfoDao.qryBlanceByUserId(accountId);<br>        <span class="hljs-comment">//余额不足正常逻辑</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">new</span> BigDecimal(blance).compareTo(<span class="hljs-keyword">new</span> BigDecimal(money))&lt;<span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;余额不足&quot;</span>);<br>        &#125;<br><br><span class="hljs-comment">//        TransactionalUtil.afterCommit(() -&gt; &#123;</span><br><span class="hljs-comment">//            ((PayService) AopContext.currentProxy()).updateProductStore(1);</span><br><span class="hljs-comment">//        &#125;);</span><br>        <span class="hljs-comment">//更新余额</span><br>        <span class="hljs-keyword">int</span> retVal = accountInfoDao.updateAccountBlance(accountId,money);<br>    &#125;<br></code></pre></td></tr></table></figure>



<h2 id="异步事务插件（事务提交后执行）"><a href="#异步事务插件（事务提交后执行）" class="headerlink" title="异步事务插件（事务提交后执行）"></a>异步事务插件（事务提交后执行）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">VoidSupplier</span> </span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Gets a result.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">get</span><span class="hljs-params">()</span></span>;<br>&#125;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadPoolUtil</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 线程池execute</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadPoolName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> supplier</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(String threadPoolName, VoidSupplier supplier)</span> </span>&#123;<br>        ThreadPoolTaskExecutor executor = SpringUtil.getBean(threadPoolName, ThreadPoolTaskExecutor.class);<br>        executor.execute(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                supplier.get();<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>                log.error(<span class="hljs-string">&quot;Unexpected error occurred invoking thread pool execute&quot;</span>, e);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransactionalUtil</span> </span>&#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> DataSource dataSource;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DataSource MY_DATA_SOURCE;<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>        MY_DATA_SOURCE = dataSource;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> supplier 执行任务</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterCommit</span><span class="hljs-params">(VoidSupplier supplier)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">if</span> (!TransactionSynchronizationManager.isSynchronizationActive()) &#123;<br>            supplier.get();<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        TransactionSynchronizationManager.registerSynchronization(<span class="hljs-keyword">new</span> TransactionSynchronizationAdapter() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterCommit</span><span class="hljs-params">()</span> </span>&#123;<br>                supplier.get();<br>            &#125;<br>        &#125;);<br>    &#125;<br>    <br>    <br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 事务提交后异步操作</span><br><span class="hljs-comment">     * 可指定线程池</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadPoolName 线程池名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> supplier       执行任务</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">asyncAfterCommit</span><span class="hljs-params">(String threadPoolName,VoidSupplier supplier)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (!TransactionSynchronizationManager.isSynchronizationActive()) &#123;<br>            ThreadPoolUtil.execute(threadPoolName, supplier);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        TransactionSynchronizationManager.registerSynchronization(<span class="hljs-keyword">new</span> TransactionSynchronizationAdapter() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterCommit</span><span class="hljs-params">()</span> </span>&#123;<br>                ThreadPoolUtil.execute(threadPoolName, supplier);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-meta">@Target(ElementType.METHOD)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> AsyncAfterCommit &#123;<br>    <span class="hljs-function">String <span class="hljs-title">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> DEFAULT_EXECUTOR_POOL</span>;<br>&#125;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Order(1)</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncAfterCommitAspect</span> </span>&#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> AsyncUncaughtExceptionHandler syncUncaughtExceptionHandler;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 所有被<span class="hljs-doctag">@AsyncAfterCommit</span>注解的方法，</span><br><span class="hljs-comment">     * 标注这个注解的方法，拥有提交事务后，异步执行的功能</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> point</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> asyncAfterCommit</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Throwable</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Around(&quot;@annotation(asyncAfterCommit)&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">around</span><span class="hljs-params">(ProceedingJoinPoint point, AsyncAfterCommit asyncAfterCommit)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        String value = asyncAfterCommit.value();<br>        Method method = AopUtil.getMethodFromJoinPoint(point);<br>        Class&lt;?&gt; returnType = method.getReturnType();<br><br>        <span class="hljs-comment">// 由于future模式通常需要使用get方法，而【提交事务后】异步执行，无法在方法内获得运算结果。基于此，不提供future模式</span><br>        <span class="hljs-keyword">if</span> (ListenableFuture.class.isAssignableFrom(returnType)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AsyncAfterException(<span class="hljs-string">&quot;@AsyncAfterCommit不支持ListenableFuture模式&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Future.class.isAssignableFrom(returnType)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AsyncAfterException(<span class="hljs-string">&quot;@AsyncAfterCommit不支持Future模式&quot;</span>);<br>        &#125;<br><br>        TransactionalUtil.asyncAfterCommit(value, () -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                point.proceed();<br>            &#125; <span class="hljs-keyword">catch</span> (ExecutionException var2) &#123;<br>                handleError(var2.getCause(), method, point.getArgs());<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable var3) &#123;<br>                handleError(var3, method, point.getArgs());<br>            &#125;<br>        &#125;);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleError</span><span class="hljs-params">(Throwable ex, Method method, Object... params)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            syncUncaughtExceptionHandler.handleUncaughtException(ex, method, params);<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var5) &#123;<br>            log.error(<span class="hljs-string">&quot;Exception handler for async method &#x27;&quot;</span> + method.toGenericString() + <span class="hljs-string">&quot;&#x27; threw unexpected &quot;</span> +<br>                    <span class="hljs-string">&quot;exception itself&quot;</span>, var5);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>用法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"> 	<span class="hljs-meta">@Transactional</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@DistributedLock(spelKey = &quot;#accountId&quot;)</span><br>    <span class="hljs-meta">@AsyncAfterCommit</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pay</span><span class="hljs-params">(String accountId, <span class="hljs-keyword">double</span> money)</span> </span>&#123;<br>        <span class="hljs-comment">//查询余额</span><br>        <span class="hljs-keyword">double</span> blance = accountInfoDao.qryBlanceByUserId(accountId);<br>        <span class="hljs-comment">//余额不足正常逻辑</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">new</span> BigDecimal(blance).compareTo(<span class="hljs-keyword">new</span> BigDecimal(money))&lt;<span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;余额不足&quot;</span>);<br>        &#125;<br><br><span class="hljs-comment">//        TransactionalUtil.afterCommit(() -&gt; &#123;</span><br><span class="hljs-comment">//            ((PayService) AopContext.currentProxy()).updateProductStore(1);</span><br><span class="hljs-comment">//        &#125;);</span><br>        <span class="hljs-comment">//更新余额</span><br>        <span class="hljs-keyword">int</span> retVal = accountInfoDao.updateAccountBlance(accountId,money);<br>    &#125;<br></code></pre></td></tr></table></figure>

<ol>
<li><p>定制化报错通知报警</p>
<p>思路：</p>
<p>1、定义一个注解BizService</p>
<p>2、声明一个切面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BizServiceAspect</span> </span>&#123;<br><br>    <span class="hljs-comment">//切自定义注解</span><br>    <span class="hljs-meta">@Pointcut(&quot;@within(自定义注解)&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">bizServiceCut</span><span class="hljs-params">()</span> </span>&#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Around(&quot;bizServiceCut()&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">doAround</span><span class="hljs-params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Object[] args = proceedingJoinPoint.getArgs();<br>            <span class="hljs-keyword">return</span> proceedingJoinPoint.proceed(args);<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 发布告警事件</span><br>                Class bizClazz = proceedingJoinPoint.getTarget().getClass();<br>                Object source = proceedingJoinPoint.getThis();<br>                Signature sig = proceedingJoinPoint.getSignature();<br>                <span class="hljs-keyword">if</span> (sig <span class="hljs-keyword">instanceof</span> MethodSignature) &#123;<br>                    MethodSignature targetMethod = (MethodSignature) sig;<br>                    Method bizMethod = bizClazz.getMethod(targetMethod.getName(), targetMethod.getParameterTypes());<br>                    AppContext.publishEvent(<span class="hljs-keyword">new</span> BizAlertEvent(source, bizClazz, bizMethod, getLogTranceId(), e));<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e1) &#123;<br>                log.warn(<span class="hljs-string">&quot;告警事件发布失败:&quot;</span>, e1);<br>            &#125;<br>            <span class="hljs-keyword">throw</span> e;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getLogTranceId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> MDC.get(Constant.LOG_TRACE_ID);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="接口出入参日志打印"><a href="#接口出入参日志打印" class="headerlink" title="接口出入参日志打印"></a>接口出入参日志打印</h2><p>利用切面的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebLogAspect</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> Logger logger = LoggerFactory.getLogger(WebLogAspect.class);    <br>    <span class="hljs-comment">/** 以 controller 包下定义的所有请求为切入点 */</span>    <br>    <span class="hljs-meta">@Pointcut(&quot;execution(public * com.ruankao.controller..*.*(..))&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">webLog</span><span class="hljs-params">()</span> </span>&#123;&#125;    <br>    <span class="hljs-comment">/**    </span><br><span class="hljs-comment">     * 在切点之前织入    </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> joinPoint    </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Throwable    </span><br><span class="hljs-comment">     */</span>    <br>    <span class="hljs-meta">@Before(&quot;webLog()&quot;)</span>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doBefore</span><span class="hljs-params">(JoinPoint joinPoint)</span></span>&#123;<br>        <span class="hljs-comment">// 开始打印请求日志    </span><br>        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();    <br>        HttpServletRequest request = attributes.getRequest();    <br>        <span class="hljs-comment">// 打印请求相关参数    </span><br>        logger.info(<span class="hljs-string">&quot;========================================== Start ==========================================&quot;</span>);    <br>        <span class="hljs-comment">// 打印请求 url    </span><br>        logger.info(<span class="hljs-string">&quot;URL            : &#123;&#125;&quot;</span>, request.getRequestURL().toString());    <br>        <span class="hljs-comment">// 打印 Http method    </span><br>        logger.info(<span class="hljs-string">&quot;HTTP Method    : &#123;&#125;&quot;</span>, request.getMethod());    <br>        <span class="hljs-comment">// 打印调用 controller 的全路径以及执行方法    </span><br>        logger.info(<span class="hljs-string">&quot;Class Method   : &#123;&#125;.&#123;&#125;&quot;</span>, joinPoint.getSignature().getDeclaringTypeName(), joinPoint.getSignature().getName());    <br>        <span class="hljs-comment">// 打印请求的 IP    </span><br>        logger.info(<span class="hljs-string">&quot;IP             : &#123;&#125;&quot;</span>, request.getRemoteAddr());    <br>        <span class="hljs-comment">// 打印请求入参    </span><br>        logger.info(<span class="hljs-string">&quot;Request Args   : &#123;&#125;&quot;</span>, joinPoint.getArgs());<br>    &#125;    <br>    <span class="hljs-comment">/**    </span><br><span class="hljs-comment">     * 在切点之后织入    </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Throwable    </span><br><span class="hljs-comment">     */</span>    <br>    <span class="hljs-meta">@After(&quot;webLog()&quot;)</span>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doAfter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;    <br>        logger.info(<span class="hljs-string">&quot;=========================================== End ===========================================&quot;</span>);    <br>        <span class="hljs-comment">// 每个请求之间空一行    </span><br>        logger.info(<span class="hljs-string">&quot;&quot;</span>);    <br>    &#125;    <br>    <span class="hljs-comment">/**    </span><br><span class="hljs-comment">     * 环绕    </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> proceedingJoinPoint    </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>    </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Throwable    </span><br><span class="hljs-comment">     */</span>    <br>    <span class="hljs-meta">@Around(&quot;webLog()&quot;)</span>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">doAround</span><span class="hljs-params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;    <br>        <span class="hljs-keyword">long</span> startTime = System.currentTimeMillis();    <br>        Object result = proceedingJoinPoint.proceed();    <br>        <span class="hljs-comment">// 打印出参    </span><br>        logger.info(<span class="hljs-string">&quot;Response Args  : &#123;&#125;&quot;</span>,JSON.toJSON(result));<br>        <span class="hljs-comment">// 执行耗时    </span><br>        logger.info(<span class="hljs-string">&quot;Time-Consuming : &#123;&#125; ms&quot;</span>, System.currentTimeMillis() - startTime);    <br>        <span class="hljs-keyword">return</span> result;    <br>    &#125;    <br>&#125;<br></code></pre></td></tr></table></figure>

<p>利用Filter的方式: 重新定义request response，读取内容再写入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@WebFilter(filterName = &quot;logFilter&quot;, urlPatterns = &quot;/*&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Filter</span> </span>&#123;<br><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> </span>&#123;<br>        HttpServletResponse httpServletResponse = (HttpServletResponse) servletResponse;<br>        HttpServletRequest httpServletRequest = (HttpServletRequest) servletRequest;<br><br>        <span class="hljs-comment">//转换成代理类</span><br>        ResponseWrapper wrapperResponse = <span class="hljs-keyword">new</span> ResponseWrapper(httpServletResponse);<br>        RequestWrapper requestWrapper = <span class="hljs-keyword">new</span> RequestWrapper(httpServletRequest);<br><br>        <span class="hljs-keyword">long</span> before = System.currentTimeMillis();<br><br>        <span class="hljs-comment">//通过ApplicationContext上下文（spring）找到RequestMappingHandlerMapping这个bean</span><br>        RequestMappingHandlerMapping handlerMapping = ApplicationContextUtil.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-comment">//RequestMappingHandlerMapping是对应url和处理类方法的一个类</span><br>        HandlerExecutionChain handlerChain = handlerMapping.getHandler(requestWrapper);<br>        <span class="hljs-comment">//通过处理链找到对应的HandlerMethod类</span><br>        HandlerMethod handler = (HandlerMethod) handlerChain.getHandler();<br>        <span class="hljs-comment">//HandlerMethod中有bean和method</span><br>        Object bean = handler.getBean();<span class="hljs-comment">//处理请求的类</span><br>        Method method = handler.getMethod();<span class="hljs-comment">//处理请求的方法</span><br><br>        <span class="hljs-comment">// 打印请求相关参数</span><br>        log.info(<span class="hljs-string">&quot;========================================== Start ==========================================&quot;</span>);<br>        <span class="hljs-comment">// 打印请求 url</span><br>        log.info(<span class="hljs-string">&quot;URL            : &#123;&#125;&quot;</span>, httpServletRequest.getRequestURL().toString());<br>        <span class="hljs-comment">// 打印 Http method</span><br>        log.info(<span class="hljs-string">&quot;HTTP Method    : &#123;&#125;&quot;</span>, httpServletRequest.getMethod());<br>        <span class="hljs-comment">// 打印调用 controller 的全路径以及执行方法</span><br>        log.info(<span class="hljs-string">&quot;Class Method   : &#123;&#125;.&#123;&#125;&quot;</span>, bean, method);<br>        <span class="hljs-comment">// 打印请求的 IP</span><br>        log.info(<span class="hljs-string">&quot;IP             : &#123;&#125;&quot;</span>, httpServletRequest.getRemoteAddr());<br>        <span class="hljs-comment">// 打印请求入参</span><br>        log.info(<span class="hljs-string">&quot;Request Args   : &#123;&#125;&quot;</span>, JSON.toJSON(requestWrapper.getBody()));<br><br>        log.info(<span class="hljs-string">&quot;=========================================== End ===========================================&quot;</span>);<br>        <span class="hljs-comment">// 每个请求之间空一行</span><br>        log.info(<span class="hljs-string">&quot;&quot;</span>);<br><br>        filterChain.doFilter(requestWrapper, wrapperResponse);<br>        <span class="hljs-comment">//获取返回值</span><br>        <span class="hljs-keyword">byte</span>[] content = wrapperResponse.getContent();<br>        <span class="hljs-comment">// 打印出参</span><br>        log.info(<span class="hljs-string">&quot;Response Args  : &#123;&#125;&quot;</span>, JSON.toJSON(<span class="hljs-keyword">new</span> String(content)));<br>        <span class="hljs-comment">// 执行耗时</span><br>        log.info(<span class="hljs-string">&quot;Time-Consuming : &#123;&#125; ms&quot;</span>, System.currentTimeMillis() - before);<br><br>        <span class="hljs-comment">//把返回值输出到客户端</span><br>        ServletOutputStream out = httpServletResponse.getOutputStream();<br>        out.write(content);<br>        out.flush();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResponseWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServletResponseWrapper</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> ByteArrayOutputStream buffer;<br><br>    <span class="hljs-keyword">private</span> ServletOutputStream out;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ResponseWrapper</span><span class="hljs-params">(HttpServletResponse httpServletResponse)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(httpServletResponse);<br>        buffer = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        out = <span class="hljs-keyword">new</span> WrapperOutputStream(buffer);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ServletOutputStream <span class="hljs-title">getOutputStream</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">return</span> out;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">flushBuffer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">if</span> (out != <span class="hljs-keyword">null</span>) &#123;<br>            out.flush();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] getContent() <span class="hljs-keyword">throws</span> IOException &#123;<br>        flushBuffer();<br>        <span class="hljs-keyword">return</span> buffer.toByteArray();<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WrapperOutputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServletOutputStream</span> </span>&#123;<br>        <span class="hljs-keyword">private</span> ByteArrayOutputStream bos;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">WrapperOutputStream</span><span class="hljs-params">(ByteArrayOutputStream bos)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.bos = bos;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-keyword">int</span> b)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>            bos.write(b);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isReady</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setWriteListener</span><span class="hljs-params">(WriteListener arg0)</span> </span>&#123;<br><br>        &#125;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RequestWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServletRequestWrapper</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String body;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RequestWrapper</span><span class="hljs-params">(HttpServletRequest request)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(request);<br>        StringBuilder stringBuilder = <span class="hljs-keyword">new</span> StringBuilder();<br>        BufferedReader bufferedReader = <span class="hljs-keyword">null</span>;<br>        InputStream inputStream = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            inputStream = request.getInputStream();<br>            <span class="hljs-keyword">if</span> (inputStream != <span class="hljs-keyword">null</span>) &#123;<br>                bufferedReader = <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(inputStream));<br>                <span class="hljs-keyword">char</span>[] charBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>[<span class="hljs-number">128</span>];<br>                <span class="hljs-keyword">int</span> bytesRead = -<span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">while</span> ((bytesRead = bufferedReader.read(charBuffer)) &gt; <span class="hljs-number">0</span>) &#123;<br>                    stringBuilder.append(charBuffer, <span class="hljs-number">0</span>, bytesRead);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                stringBuilder.append(<span class="hljs-string">&quot;&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br><br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (inputStream != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    inputStream.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (bufferedReader != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    bufferedReader.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>        body = stringBuilder.toString();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ServletInputStream <span class="hljs-title">getInputStream</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">final</span> ByteArrayInputStream byteArrayInputStream = <span class="hljs-keyword">new</span> ByteArrayInputStream(body.getBytes());<br>        ServletInputStream servletInputStream = <span class="hljs-keyword">new</span> ServletInputStream() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isFinished</span><span class="hljs-params">()</span> </span>&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isReady</span><span class="hljs-params">()</span> </span>&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setReadListener</span><span class="hljs-params">(ReadListener readListener)</span> </span>&#123;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-keyword">return</span> byteArrayInputStream.read();<br>            &#125;<br>        &#125;;<br>        <span class="hljs-keyword">return</span> servletInputStream;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> BufferedReader <span class="hljs-title">getReader</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(<span class="hljs-keyword">this</span>.getInputStream()));<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getBody</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.body;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="常见切面-Around-execution表达式"><a href="#常见切面-Around-execution表达式" class="headerlink" title="常见切面@Around execution表达式"></a>常见切面@Around execution表达式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//@Around(&quot;@annotation(自定义注解)&quot;)//自定义注解标注在方法上的方法执行aop方法</span><br>如：<span class="hljs-meta">@Around(&quot;@annotation(org.springframework.transaction.annotation.Transactional)&quot;)</span><br><br><span class="hljs-comment">//@Around(&quot;@within(自定义注解)&quot;)//自定义注解标注在的类上；该类的所有方法（不包含子类方法）执行aop方法</span><br>如：<span class="hljs-meta">@Around(&quot;@within(org.springframework.transaction.annotation.Transactional)&quot;)</span><br><br><span class="hljs-comment">//@Around(&quot;within(包名前缀.*)&quot;)//com.aop.within包下所有类的所有的方法都会执行(不包含子包) aop方法</span><br>如：<span class="hljs-meta">@Around(&quot;within(com.aop.test.*)&quot;)</span><br><br><span class="hljs-comment">//@Around(&quot;within(包名前缀..*)&quot;)//com.aop.within包下所有的方法都会执行(包含子包)aop 方法</span><br>如：<span class="hljs-meta">@Around(&quot;within(com.aop.test..*)&quot;)</span><br><br><span class="hljs-comment">//@Around(&quot;this(java类或接口)&quot;)//实现了该接口的类、继承该类、该类本身的类---的所有方法（包括不是接口定义的方法，但不包含父类的方法）都会执行aop方法</span><br>如：<span class="hljs-meta">@Around(&quot;this(com.aop.service.TestService)&quot;)</span><br><br><span class="hljs-comment">//@Around(&quot;target(java类或接口)&quot;)//实现了该接口的类、继承该类、该类本身的类---的所有方法（包括不是接口定义的方法，包含父类的方法）</span><br>如：<span class="hljs-meta">@Around(&quot;this(com.aop.service.TestService)&quot;)</span><br><br></code></pre></td></tr></table></figure>




    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%BA%90%E7%A0%81/" rel="tag"># 源码</a>
              <a href="/tags/Spring/" rel="tag"># Spring</a>
              <a href="/tags/AOP/" rel="tag"># AOP</a>
              <a href="/tags/%E5%88%87%E9%9D%A2%E5%BA%94%E7%94%A8/" rel="tag"># 切面应用</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/07/10/Spring06-%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%A0%81/" rel="prev" title="Spring06-事务原码">
      <i class="fa fa-chevron-left"></i> Spring06-事务原码
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/08/05/SpringBoot01-%E5%9F%BA%E7%A1%80/" rel="next" title="SpringBoot01-基础">
      SpringBoot01-基础 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring%E5%88%87%E9%9D%A2%E5%BA%94%E7%94%A8"><span class="nav-number">1.</span> <span class="nav-text">Spring切面应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E6%8F%92%E4%BB%B6-%E5%90%8E%E7%BB%AD%E8%A1%A5%E5%85%85"><span class="nav-number">1.1.</span> <span class="nav-text">多数据源插件(后续补充)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%8F%92%E4%BB%B6"><span class="nav-number">1.2.</span> <span class="nav-text">分布式锁插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E4%BA%8B%E5%8A%A1%E6%8F%92%E4%BB%B6%EF%BC%88%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4%E5%90%8E%E6%89%A7%E8%A1%8C%EF%BC%89"><span class="nav-number">1.3.</span> <span class="nav-text">异步事务插件（事务提交后执行）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E5%87%BA%E5%85%A5%E5%8F%82%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0"><span class="nav-number">1.4.</span> <span class="nav-text">接口出入参日志打印</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E5%88%87%E9%9D%A2-Around-execution%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">1.5.</span> <span class="nav-text">常见切面@Around execution表达式</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="24khandsome"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">24khandsome</p>
  <div class="site-description" itemprop="description">24khandsome's Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">24khandsome</span>
  
	<br/>
	<span id="busuanzi_container_site_pv">
		<span class="post-meta-item-icon">
			<i class="fa fa-user"></i>
		</span>
		访问量：<span id="busuanzi_value_site_pv"></span> 次数
	</span>

	<span class="post-meta-divider">|</span>
		<span id="busuanzi_container_site_uv">
			<i class="fa fa-eye"></i>
			访客数：<span id="busuanzi_value_site_uv"></span> 人次
	</span>

</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
<!-- 动态背景 -->
<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


</html>
