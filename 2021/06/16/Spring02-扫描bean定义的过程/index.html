<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Spring扫描bean定义的过程">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring02-扫描bean定义的过程">
<meta property="og:url" content="http://example.com/2021/06/16/Spring02-%E6%89%AB%E6%8F%8Fbean%E5%AE%9A%E4%B9%89%E7%9A%84%E8%BF%87%E7%A8%8B/index.html">
<meta property="og:site_name" content="24khandsome&#39;s Blog">
<meta property="og:description" content="Spring扫描bean定义的过程">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/Spring02-%E6%89%AB%E6%8F%8Fbean%E5%AE%9A%E4%B9%89%E7%9A%84%E8%BF%87%E7%A8%8B/image-20210617231054221.png">
<meta property="og:image" content="http://example.com/images/Spring02-%E6%89%AB%E6%8F%8Fbean%E5%AE%9A%E4%B9%89%E7%9A%84%E8%BF%87%E7%A8%8B/BeanDefinition%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B.png">
<meta property="article:published_time" content="2021-06-16T13:00:00.000Z">
<meta property="article:modified_time" content="2024-03-05T12:41:27.853Z">
<meta property="article:author" content="24khandsome">
<meta property="article:tag" content="源码">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="bean定义信息">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Spring02-%E6%89%AB%E6%8F%8Fbean%E5%AE%9A%E4%B9%89%E7%9A%84%E8%BF%87%E7%A8%8B/image-20210617231054221.png">

<link rel="canonical" href="http://example.com/2021/06/16/Spring02-%E6%89%AB%E6%8F%8Fbean%E5%AE%9A%E4%B9%89%E7%9A%84%E8%BF%87%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Spring02-扫描bean定义的过程 | 24khandsome's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">24khandsome's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">24khandsome's Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/16/Spring02-%E6%89%AB%E6%8F%8Fbean%E5%AE%9A%E4%B9%89%E7%9A%84%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="24khandsome">
      <meta itemprop="description" content="24khandsome's Blog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="24khandsome's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring02-扫描bean定义的过程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-16 21:00:00" itemprop="dateCreated datePublished" datetime="2021-06-16T21:00:00+08:00">2021-06-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-05 20:41:27" itemprop="dateModified" datetime="2024-03-05T20:41:27+08:00">2024-03-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
            </span>

          
            <div class="post-description">Spring扫描bean定义的过程</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>一、讲前扩展</p>
<p>​    1、源码扩展之事件监听机制</p>
<p>​    2、源码扩展之BeanFactoryPostProcessor</p>
<p>二、Spring扫描bean定义的源码分析</p>
<h1 id="讲前拓展"><a href="#讲前拓展" class="headerlink" title="讲前拓展"></a>讲前拓展</h1><h2 id="事件监听机制"><a href="#事件监听机制" class="headerlink" title="事件监听机制"></a>事件监听机制</h2><p>概述：本质上是观察者模式程序设计的体现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApplicationListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ApplicationListener</span></span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onApplicationEvent</span><span class="hljs-params">(ApplicationEvent event)</span></span>&#123;<br>        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;收到事件:&quot;</span>+event);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/images/Spring02-%E6%89%AB%E6%8F%8Fbean%E5%AE%9A%E4%B9%89%E7%9A%84%E8%BF%87%E7%A8%8B/image-20210617231054221.png" alt="image-20210617231054221"></p>
<ul>
<li>i1&gt;org.springframework.context.support.AbstractApplicationContext#refresh<ul>
<li>i2&gt;org.springframework.context.support.AbstractApplicationContext#initApplicationEventMulticaster（初始化事件多播器）</li>
<li>i3&gt;org.springframework.context.support.AbstractApplicationContext#registerListeners（把事件监听器注册到多播器上去）</li>
</ul>
</li>
</ul>
<p><strong>i2(初始化事件多播器源码解析)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initApplicationEventMulticaster</span><span class="hljs-params">()</span> </span>&#123;<br>		ConfigurableListableBeanFactory beanFactory = getBeanFactory();<br>		/判断IOC容器中包含applicationEventMulticaster 事件多播器的Bean的name<br>		<span class="hljs-keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;<br>		    /创建一个applicationEventMulticaster的bean放在IOC 容器中,bean的name 为applicationEventMulticaster<br>			<span class="hljs-keyword">this</span>.applicationEventMulticaster =beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);<br>			<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>				logger.debug(<span class="hljs-string">&quot;Using ApplicationEventMulticaster [&quot;</span> + <span class="hljs-keyword">this</span>.applicationEventMulticaster + <span class="hljs-string">&quot;]&quot;</span>);<br>			&#125;<br>		&#125;<br>		/容器中不包含一个beanName 为applicationEventMulticaster的多播器组件<br>		<span class="hljs-keyword">else</span> &#123;<br>		    <span class="hljs-comment">//创建一个SimpleApplicationEventMulticaster 多播器</span><br>			<span class="hljs-keyword">this</span>.applicationEventMulticaster = <span class="hljs-keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);<br>			<span class="hljs-comment">//注册到容器中</span><br>			beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="hljs-keyword">this</span>.applicationEventMulticaster);<br>			<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>				logger.debug(<span class="hljs-string">&quot;Unable to locate ApplicationEventMulticaster with name &#x27;&quot;</span> +<br>						APPLICATION_EVENT_MULTICASTER_BEAN_NAME +<br>						<span class="hljs-string">&quot;&#x27;: using default [&quot;</span> + <span class="hljs-keyword">this</span>.applicationEventMulticaster + <span class="hljs-string">&quot;]&quot;</span>);<br>			&#125;<br>		&#125;<br>	&#125;​<br></code></pre></td></tr></table></figure>

<p><strong>i3：把容器中的监听器注册到多播器上去 源码解析</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerListeners</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-comment">//去容器中把applicationListener 捞取出来注册到多播器上去（系统的）</span><br>		<span class="hljs-keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;<br>			getApplicationEventMulticaster().addApplicationListener(listener);<br>		&#125;<br><br>        <span class="hljs-comment">//我们自己实现了ApplicationListener 的组件</span><br>		String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br>		<span class="hljs-keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;<br>			getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);<br>		&#125;<br><br>	    <span class="hljs-comment">//在这里之前，我们早期想发布的事件 由于没有多播器没有发布，在这里我们总算有了自己的多播器，可以在这里发布早期堆积的事件了.</span><br>		Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="hljs-keyword">this</span>.earlyApplicationEvents;<br>		<span class="hljs-keyword">this</span>.earlyApplicationEvents = <span class="hljs-keyword">null</span>;<br>		<span class="hljs-keyword">if</span> (earlyEventsToProcess != <span class="hljs-keyword">null</span>) &#123;<br>			<span class="hljs-keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;<br>				getApplicationEventMulticaster().multicastEvent(earlyEvent);<br>			&#125;<br>		&#125;<br>	&#125;<br>	<br>	------------------------------------如何发布事件-------------------------------------<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">multicastEvent</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ApplicationEvent event, ResolvableType eventType)</span> </span>&#123;<br>		ResolvableType type = (eventType != <span class="hljs-keyword">null</span> ? eventType : resolveDefaultEventType(event));<br>		<span class="hljs-comment">//获取到所有的监听器</span><br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> ApplicationListener&lt;?&gt; listener : getApplicationListeners(event, type)) &#123;<br>		    <span class="hljs-comment">//看spring 容器中是否支持线程池 异步发送事件</span><br>			Executor executor = getTaskExecutor();<br>			<span class="hljs-keyword">if</span> (executor != <span class="hljs-keyword">null</span>) &#123;<br>				executor.execute(<span class="hljs-keyword">new</span> Runnable() &#123;<br>					<span class="hljs-meta">@Override</span><br>					<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;	    <br>						invokeListener(listener, event);<br>					&#125;<br>				&#125;);<br>			&#125;<br>			<span class="hljs-keyword">else</span> &#123;  <span class="hljs-comment">//同步发送事件</span><br>				invokeListener(listener, event);<br>			&#125;<br>		&#125;<br>	&#125;	<br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doInvokeListener</span><span class="hljs-params">(ApplicationListener listener, ApplicationEvent event)</span> </span>&#123;<br>		<span class="hljs-keyword">try</span> &#123;<br>		    <span class="hljs-comment">//调用对于listener的onApplicationEvent事件</span><br>			listener.onApplicationEvent(event);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (ClassCastException ex) &#123;<br>			String msg = ex.getMessage();<br>			<span class="hljs-keyword">if</span> (msg == <span class="hljs-keyword">null</span> || matchesClassCastMessage(msg, event.getClass())) &#123;<br>				<span class="hljs-comment">// Possibly a lambda-defined listener which we could not resolve the generic event type for</span><br>				<span class="hljs-comment">// -&gt; let&#x27;s suppress the exception and just log a debug message.</span><br>				Log logger = LogFactory.getLog(getClass());<br>				<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>					logger.debug(<span class="hljs-string">&quot;Non-matching event type for listener: &quot;</span> + listener, ex);<br>				&#125;<br>			&#125;<br>			<span class="hljs-keyword">else</span> &#123;<br>				<span class="hljs-keyword">throw</span> ex;<br>			&#125;<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p><strong>如何定制事件多波器并且在线程池中执行？</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component(&quot;applicationEventMulticaster&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApplicationEventMulticaster</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleApplicationEventMulticaster</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyApplicationEventMulticaster</span><span class="hljs-params">(BeanFactory beanFactory)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(beanFactory);<br>        setTaskExecutor(<span class="hljs-keyword">new</span> ThreadPoolExecutor(<span class="hljs-number">2</span>, <span class="hljs-number">5</span>,<br>                <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,<br>                <span class="hljs-keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(),<br>                Executors.defaultThreadFactory()));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="BeanFactoryPostProcessor"><a href="#BeanFactoryPostProcessor" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h2><p>BeanFactory（创建bean的工厂）的后置处理器。</p>
<p>分两种</p>
<ol>
<li>BeanFactoryPostProcessor beanFactory把bean定义信息加载完毕，初始化前<ol>
<li>可以对某些bean定义信息做一些特殊配置</li>
</ol>
</li>
<li>MyBeanDefinitionRegistryPostProcessor Spring内置bean定义信息加载后，初始化前<ol>
<li>可以新增、删除bean定义信息等操作</li>
</ol>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyBeanDefinitionRegistryPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">BeanDefinitionRegistryPostProcessor</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>        <span class="hljs-comment">//(spring内置BeanDefinition读取后),bean初始化前，做一些新增beanDefinition等操作</span><br>        System.out.println(<span class="hljs-string">&quot;MyBeanDefinitionRegistryPostProcessor....postProcessBeanDefinitionRegistry&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;bean 的数量&quot;</span> + registry.getBeanDefinitionCount());<br>        registry.registerBeanDefinition(<span class="hljs-string">&quot;tooth&quot;</span>,<span class="hljs-keyword">new</span> RootBeanDefinition(TestController.class));<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>        <span class="hljs-comment">//BeanDefinition读取之后，bean初始化前</span><br>        System.out.println(<span class="hljs-string">&quot;MyBeanDefinitionRegistryPostProcessor postProcessBeanFactory....bean 的数量&quot;</span> + beanFactory.getBeanDefinitionCount());<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>i1:org.springframework.context.support.AbstractApplicationContext#refresh<ul>
<li>i2:org.springframework.context.support.AbstractApplicationContext#invokeBeanFactoryPostProcessors<ul>
<li>&gt;i3:org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors<ul>
<li>&gt;i4:org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanDefinitionRegistryPostProcessors<ul>
<li>&gt;i5:org.springframework.context.annotation.ConfigurationClassPostProcessor#processConfigBeanDefinitions<ul>
<li>&gt; i6:org.springframework.context.annotation.ConfigurationClassParser#parse<ul>
<li>&gt;i7:org.springframework.context.annotation.ConfigurationClassParser#processConfigurationClass<ul>
<li>&gt;i8:org.springframework.context.annotation.ConfigurationClassParser#doProcessConfigurationClass</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="i4标记处源码解析"><a href="#i4标记处源码解析" class="headerlink" title="i4标记处源码解析"></a>i4标记处源码解析</h3><p>org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">			ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> </span>&#123;<br><br>		<span class="hljs-comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span><br>		Set&lt;String&gt; processedBeans = <span class="hljs-keyword">new</span> HashSet&lt;String&gt;();<br>        <br>        <span class="hljs-comment">//判断IOC 容器是不是BeanDefinitionRegistry的？</span><br>		<span class="hljs-keyword">if</span> (beanFactory <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistry) &#123;<br>		    <span class="hljs-comment">//把IOC容器 强制转为BeanDefinitionRegistry类型的</span><br>			BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;<br>			<span class="hljs-comment">//创建一个普通的PostProcessors的list的组件</span><br>			List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="hljs-keyword">new</span> LinkedList&lt;BeanFactoryPostProcessor&gt;();<br>			<span class="hljs-comment">//创建一个BeanDefinitionRegistryPostProcessor类型的list</span><br>			List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="hljs-keyword">new</span> LinkedList&lt;BeanDefinitionRegistryPostProcessor&gt;();<br>            <br>            <span class="hljs-comment">//处理容器硬编码(new 出来的)带入的beanFacotryPostProcessors</span><br>			<span class="hljs-keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;<br>			    <span class="hljs-comment">//判断是不是BeanDefinitionRegistryPostProcessor</span><br>				<span class="hljs-keyword">if</span> (postProcessor <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;<br>				    <br>					BeanDefinitionRegistryPostProcessor registryProcessor =<br>							(BeanDefinitionRegistryPostProcessor) postProcessor;<br>					<span class="hljs-comment">//调用BeanDefinitionRegistryPostProcessor的postProcessBeanDefinitionRegistry</span><br>					registryProcessor.postProcessBeanDefinitionRegistry(registry);<br>					<span class="hljs-comment">//加入到list集合中</span><br>					registryProcessors.add(registryProcessor);<br>				&#125;<br>				<span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//判断不是BeanDefinitionRegistryPostProcessor</span><br>				    <span class="hljs-comment">//加入到集合中</span><br>					regularPostProcessors.add(postProcessor);<br>				&#125;<br>			&#125;<br><br>            <span class="hljs-comment">//创建一个当前注册的RegistryProcessors的集合</span><br>			List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;BeanDefinitionRegistryPostProcessor&gt;();<br><br>			第一步:去容器中查询是否有BeanDefinitionRegistryPostProcessor类型的<br>			String[] postProcessorNames =<br>					beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br>			<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>			    <span class="hljs-comment">//判断是不是实现了PriorityOrdered接口的</span><br>				<span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>				    <span class="hljs-comment">//添加到currentRegistryProcessors的集合中</span><br>					currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>					<span class="hljs-comment">//添加到processedBeans的集合中</span><br>					processedBeans.add(ppName);<br>				&#125;<br>			&#125;<br>			<span class="hljs-comment">//进行排序</span><br>			sortPostProcessors(currentRegistryProcessors, beanFactory);<br>			registryProcessors.addAll(currentRegistryProcessors);<br>			<span class="hljs-comment">//调用BeanDefinitionRegistryPostProcessors的postProcessBeanDefinitionRegistry方法</span><br>			invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);<br>			currentRegistryProcessors.clear();<br><br>			<span class="hljs-comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span><br>			第二步:去容器中查询是否有BeanDefinitionRegistryPostProcessor类型的<br>			<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>			    <span class="hljs-comment">//排除被处理过的，并且实现了Ordered接口的</span><br>				<span class="hljs-keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>					currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>					<span class="hljs-comment">//加到以处理的list中</span><br>					processedBeans.add(ppName);<br>				&#125;<br>			&#125;<br>			sortPostProcessors(currentRegistryProcessors, beanFactory);<br>			registryProcessors.addAll(currentRegistryProcessors);<br>			<span class="hljs-comment">//调用BeanDefinitionRegistryPostProcessors的postProcessBeanDefinitionRegistry方法</span><br>			invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);<br>			currentRegistryProcessors.clear();<br><br>			<span class="hljs-comment">//调用普通的BeanDefinitionRegistryPostProcessors没用实现 PriorithOrdered和Ordered接口</span><br>			<span class="hljs-keyword">boolean</span> reiterate = <span class="hljs-keyword">true</span>;<br>			<span class="hljs-keyword">while</span> (reiterate) &#123;<br>				reiterate = <span class="hljs-keyword">false</span>;<br>				postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br>				<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>					<span class="hljs-keyword">if</span> (!processedBeans.contains(ppName)) &#123;<br>						currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>						processedBeans.add(ppName);<br>						reiterate = <span class="hljs-keyword">true</span>;<br>					&#125;<br>				&#125;<br>				sortPostProcessors(currentRegistryProcessors, beanFactory);<br>				registryProcessors.addAll(currentRegistryProcessors);<br>				invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);<br>				currentRegistryProcessors.clear();<br>			&#125;<br><br>			<span class="hljs-comment">//调用上诉实现了也实现了BeanFactoryPostProcessors的接口</span><br>			invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);<br>			invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);<br>		&#125;<br><br>		<span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// Invoke factory processors registered with the context instance.</span><br>			invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);<br>		&#125;<br><br>        <span class="hljs-comment">//去IOC 容器中获取BeanFactoryPostProcessor 类型的</span><br>		String[] postProcessorNames =<br>				beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br><br>        <span class="hljs-comment">//分离实现了PriorityOrdered接口的 Ordered 接口的   普通的</span><br>		List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;BeanFactoryPostProcessor&gt;();<br>		List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;();<br>		List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;();<br>		<br>		<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>			<span class="hljs-keyword">if</span> (processedBeans.contains(ppName)) &#123;<br>				<span class="hljs-comment">// skip - already processed in first phase above</span><br>			&#125;<br>			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>				priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));<br>			&#125;<br>			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>				orderedPostProcessorNames.add(ppName);<br>			&#125;<br>			<span class="hljs-keyword">else</span> &#123;<br>				nonOrderedPostProcessorNames.add(ppName);<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">//调用 PriorityOrdered.</span><br>		sortPostProcessors(priorityOrderedPostProcessors, beanFactory);<br>		invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);<br><br>		<span class="hljs-comment">//调用 Ordered.</span><br>		List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;BeanFactoryPostProcessor&gt;();<br>		<span class="hljs-keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;<br>			orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));<br>		&#125;<br>		sortPostProcessors(orderedPostProcessors, beanFactory);<br>		invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);<br><br>	    <span class="hljs-comment">//调用普通的</span><br>		List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;BeanFactoryPostProcessor&gt;();<br>		<span class="hljs-keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;<br>			nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));<br>		&#125;<br>		invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);<br><br>		<span class="hljs-comment">// Clear cached merged bean definitions since the post-processors might have</span><br>		<span class="hljs-comment">// modified the original metadata, e.g. replacing placeholders in values...</span><br>		beanFactory.clearMetadataCache();<br>	&#125;<br></code></pre></td></tr></table></figure>

<h3 id="i5标记处源码解析"><a href="#i5标记处源码解析" class="headerlink" title="i5标记处源码解析:"></a>i5标记处源码解析:</h3><p>org.springframework.context.annotation.ConfigurationClassPostProcessor#processConfigBeanDefinitions </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processConfigBeanDefinitions</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> </span>&#123;<br>		List&lt;BeanDefinitionHolder&gt; configCandidates = <span class="hljs-keyword">new</span> ArrayList&lt;BeanDefinitionHolder&gt;();<br>		<span class="hljs-comment">//去IOC容器中的获取Bean定义的名称</span><br>		<span class="hljs-comment">//	private volatile List&lt;String&gt; beanDefinitionNames = new ArrayList&lt;String&gt;(256);</span><br>        <br>        <span class="hljs-comment">//没有解析之前，系统候选的bean定义配置(有自己的 有系统自带的)</span><br>		String[] candidateNames = registry.getBeanDefinitionNames();<br>        <br>        <span class="hljs-comment">//循环Bean定义的名称 找出自己的传入的主配置类的bean定义信息  configCandidates</span><br>		<span class="hljs-keyword">for</span> (String beanName : candidateNames) &#123;<br>		    <span class="hljs-comment">//去bean定义的map中获取对应的Bean定义对象</span><br>		    <span class="hljs-comment">//	private final Map&lt;String, BeanDefinition&gt; beanDefinitionMap = new ConcurrentHashMap&lt;String, BeanDefinition&gt;(256);</span><br>			BeanDefinition beanDef = registry.getBeanDefinition(beanName);<br>			<span class="hljs-comment">//检查该bean定义对象是不是用来描述配置类</span><br>			<span class="hljs-keyword">if</span> (ConfigurationClassUtils.isFullConfigurationClass(beanDef) ||<br>					ConfigurationClassUtils.isLiteConfigurationClass(beanDef)) &#123;<br>				<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>					logger.debug(<span class="hljs-string">&quot;Bean definition has already been processed as a configuration class: &quot;</span> + beanDef);<br>				&#125;<br>			&#125;<br>			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, <span class="hljs-keyword">this</span>.metadataReaderFactory)) &#123;<br>				configCandidates.add(<span class="hljs-keyword">new</span> BeanDefinitionHolder(beanDef, beanName));<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// Return immediately if no @Configuration classes were found</span><br>		<span class="hljs-keyword">if</span> (configCandidates.isEmpty()) &#123;<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br><br>		<span class="hljs-comment">//检查配置类排序</span><br>		Collections.sort(configCandidates, <span class="hljs-keyword">new</span> Comparator&lt;BeanDefinitionHolder&gt;() &#123;<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(BeanDefinitionHolder bd1, BeanDefinitionHolder bd2)</span> </span>&#123;<br>				<span class="hljs-keyword">int</span> i1 = ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());<br>				<span class="hljs-keyword">int</span> i2 = ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());<br>				<span class="hljs-keyword">return</span> (i1 &lt; i2) ? -<span class="hljs-number">1</span> : (i1 &gt; i2) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;<br>			&#125;<br>		&#125;);<br><br>		<span class="hljs-comment">// bean的名称生成策略</span><br>		SingletonBeanRegistry sbr = <span class="hljs-keyword">null</span>;<br>		<span class="hljs-keyword">if</span> (registry <span class="hljs-keyword">instanceof</span> SingletonBeanRegistry) &#123;<br>			sbr = (SingletonBeanRegistry) registry;<br>			<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.localBeanNameGeneratorSet &amp;&amp; sbr.containsSingleton(CONFIGURATION_BEAN_NAME_GENERATOR)) &#123;<br>				BeanNameGenerator generator = (BeanNameGenerator) sbr.getSingleton(CONFIGURATION_BEAN_NAME_GENERATOR);<br>				<span class="hljs-keyword">this</span>.componentScanBeanNameGenerator = generator;<br>				<span class="hljs-keyword">this</span>.importBeanNameGenerator = generator;<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">/***创建一个配置类解析器</span><br><span class="hljs-comment">		1)元数据读取器工厂</span><br><span class="hljs-comment">		this.metadataReaderFactory = metadataReaderFactory;</span><br><span class="hljs-comment">		2)问题报告器</span><br><span class="hljs-comment">		this.problemReporter = problemReporter;</span><br><span class="hljs-comment">		//设置环境</span><br><span class="hljs-comment">		this.environment = environment;</span><br><span class="hljs-comment">		3)资源加载器</span><br><span class="hljs-comment">		this.resourceLoader = resourceLoader;</span><br><span class="hljs-comment">		4）创建了一个组件扫描器</span><br><span class="hljs-comment">		this.componentScanParser = new ComponentScanAnnotationParser(</span><br><span class="hljs-comment">				environment, resourceLoader, componentScanBeanNameGenerator, registry);</span><br><span class="hljs-comment">		this.conditionEvaluator = new ConditionEvaluator(registry, environment, resourceLoader);</span><br><span class="hljs-comment">		****/</span><br>		<br>		ConfigurationClassParser parser = <span class="hljs-keyword">new</span> ConfigurationClassParser(<br>				<span class="hljs-keyword">this</span>.metadataReaderFactory, <span class="hljs-keyword">this</span>.problemReporter, <span class="hljs-keyword">this</span>.environment,<br>				<span class="hljs-keyword">this</span>.resourceLoader, <span class="hljs-keyword">this</span>.componentScanBeanNameGenerator, registry);<br>        <br>        <br>        <span class="hljs-comment">//将要被解析的配置类(把自己的configCandidates加入到 候选的)</span><br>		Set&lt;BeanDefinitionHolder&gt; candidates = <span class="hljs-keyword">new</span> LinkedHashSet&lt;BeanDefinitionHolder&gt;(configCandidates);<br>		<span class="hljs-comment">//已经被解析的配置类(由于do while 那么mainclass就一定会被解析,被解析的size为1)</span><br>		Set&lt;ConfigurationClass&gt; alreadyParsed = <span class="hljs-keyword">new</span> HashSet&lt;ConfigurationClass&gt;(configCandidates.size());<br>		<span class="hljs-keyword">do</span> &#123;<br>		    <span class="hljs-comment">//通过配置解析器真正的解析配置类</span><br>			parser.parse(candidates);<br>			<br>			<span class="hljs-comment">//进行校验</span><br>			parser.validate();<br>            <br>            <span class="hljs-comment">//获取ConfigClass (把解析过的配置bean定义信息获取出来)</span><br>			Set&lt;ConfigurationClass&gt; configClasses = <span class="hljs-keyword">new</span> LinkedHashSet&lt;ConfigurationClass&gt;(parser.getConfigurationClasses());<br>			configClasses.removeAll(alreadyParsed);<br><br>			<span class="hljs-comment">// Read the model and create bean definitions based on its content</span><br>			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.reader == <span class="hljs-keyword">null</span>) &#123;<br>				<span class="hljs-keyword">this</span>.reader = <span class="hljs-keyword">new</span> ConfigurationClassBeanDefinitionReader(<br>						registry, <span class="hljs-keyword">this</span>.sourceExtractor, <span class="hljs-keyword">this</span>.resourceLoader, <span class="hljs-keyword">this</span>.environment,<br>						<span class="hljs-keyword">this</span>.importBeanNameGenerator, parser.getImportRegistry());<br>			&#125;<br>			<br>			<span class="hljs-comment">//@CompentScan是直接注册Bean定义信息的    但是通过获取@Import,@Bean这种的注解还没有注册的bean定义,</span><br>			<span class="hljs-keyword">this</span>.reader.loadBeanDefinitions(configClasses);<br>			<span class="hljs-comment">//把系统解析过我们自己的组件放在alreadyParsed</span><br>			alreadyParsed.addAll(configClasses);<br>            <span class="hljs-comment">//清除解析过的 配置文件 </span><br>			candidates.clear();<br>			<br>			<span class="hljs-comment">//已经注册的bean定义个数大于最新 开始系统+主配置类的(发生过解析)</span><br>			<span class="hljs-keyword">if</span> (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;<br>			    <span class="hljs-comment">//获取系统+自己解析的+mainconfig的bean定义信息</span><br>				String[] newCandidateNames = registry.getBeanDefinitionNames();<br>				<span class="hljs-comment">//系统的+mainconfig的bean定义信息</span><br>				Set&lt;String&gt; oldCandidateNames = <span class="hljs-keyword">new</span> HashSet&lt;String&gt;(Arrays.asList(candidateNames));<br>				<br>				<span class="hljs-comment">//已经解析过的自己的组件</span><br>				Set&lt;String&gt; alreadyParsedClasses = <span class="hljs-keyword">new</span> HashSet&lt;String&gt;();<br>				<span class="hljs-keyword">for</span> (ConfigurationClass configurationClass : alreadyParsed) &#123;<br>					alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());<br>				&#125;<br>				<br>				<span class="hljs-keyword">for</span> (String candidateName : newCandidateNames) &#123;<br>				    <span class="hljs-comment">//老的（系统+mainconfig） 不包含解析的</span><br>					<span class="hljs-keyword">if</span> (!oldCandidateNames.contains(candidateName)) &#123;<br>					    <span class="hljs-comment">//把当前bean定义获取出来</span><br>						BeanDefinition bd = registry.getBeanDefinition(candidateName);<br>						<span class="hljs-comment">//检查是否为解析过的</span><br>						<span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, <span class="hljs-keyword">this</span>.metadataReaderFactory) &amp;&amp;<br>								!alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;<br>							<span class="hljs-comment">//若不是解析过且通过检查的     把当前的bean定义 加入到candidates中	    </span><br>							candidates.add(<span class="hljs-keyword">new</span> BeanDefinitionHolder(bd, candidateName));<br>						&#125;<br>					&#125;<br>				&#125;<br>				把解析过的赋值给原来的 <br>				candidateNames = newCandidateNames;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">while</span> (!candidates.isEmpty());  <span class="hljs-comment">//还存主没有解析过的  再次解析</span><br><br>		<span class="hljs-comment">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span><br>		<span class="hljs-keyword">if</span> (sbr != <span class="hljs-keyword">null</span>) &#123;<br>			<span class="hljs-keyword">if</span> (!sbr.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) &#123;<br>				sbr.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.metadataReaderFactory <span class="hljs-keyword">instanceof</span> CachingMetadataReaderFactory) &#123;<br>			((CachingMetadataReaderFactory) <span class="hljs-keyword">this</span>.metadataReaderFactory).clearCache();<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<h3 id="i6标记处源码解析"><a href="#i6标记处源码解析" class="headerlink" title="i6标记处源码解析 :"></a>i6标记处源码解析 :</h3><p>org.springframework.context.annotation.ConfigurationClassParser#parse</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parse</span><span class="hljs-params">(Set&lt;BeanDefinitionHolder&gt; configCandidates)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.deferredImportSelectors = <span class="hljs-keyword">new</span> LinkedList&lt;DeferredImportSelectorHolder&gt;();<br><br>		<span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : configCandidates) &#123;<br>			BeanDefinition bd = holder.getBeanDefinition();<br>			<span class="hljs-keyword">try</span> &#123;<br>			    <span class="hljs-comment">//注解形式的bean定义信息</span><br>				<span class="hljs-keyword">if</span> (bd <span class="hljs-keyword">instanceof</span> AnnotatedBeanDefinition) &#123;<br>				    <span class="hljs-comment">//解析配置类的bean定义</span><br>					parse(((AnnotatedBeanDefinition) bd).getMetadata(), holder.getBeanName());<br>				&#125;<br>				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bd <span class="hljs-keyword">instanceof</span> AbstractBeanDefinition &amp;&amp; ((AbstractBeanDefinition) bd).hasBeanClass()) &#123;<br>					parse(((AbstractBeanDefinition) bd).getBeanClass(), holder.getBeanName());<br>				&#125;<br>				<span class="hljs-keyword">else</span> &#123;<br>					parse(bd.getBeanClassName(), holder.getBeanName());<br>				&#125;<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) &#123;<br>				<span class="hljs-keyword">throw</span> ex;<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(<br>						<span class="hljs-string">&quot;Failed to parse configuration class [&quot;</span> + bd.getBeanClassName() + <span class="hljs-string">&quot;]&quot;</span>, ex);<br>			&#125;<br>		&#125;<br><br>		processDeferredImportSelectors();<br>	&#125;​<br>	<br>	<br>org.springframework.context.annotation.ConfigurationClassParser#parse<br>	org.springframework.context.annotation.ConfigurationClassParser#processConfigurationClass<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processConfigurationClass</span><span class="hljs-params">(ConfigurationClass configClass)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.conditionEvaluator.shouldSkip(configClass.getMetadata(), ConfigurationPhase.PARSE_CONFIGURATION)) &#123;<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br><br>		ConfigurationClass existingClass = <span class="hljs-keyword">this</span>.configurationClasses.get(configClass);<br>		<span class="hljs-keyword">if</span> (existingClass != <span class="hljs-keyword">null</span>) &#123;<br>			<span class="hljs-keyword">if</span> (configClass.isImported()) &#123;<br>				<span class="hljs-keyword">if</span> (existingClass.isImported()) &#123;<br>					existingClass.mergeImportedBy(configClass);<br>				&#125;<br>				<span class="hljs-comment">// Otherwise ignore new imported config class; existing non-imported class overrides it.</span><br>				<span class="hljs-keyword">return</span>;<br>			&#125;<br>			<span class="hljs-keyword">else</span> &#123;<br>				<span class="hljs-comment">// Explicit bean definition found, probably replacing an import.</span><br>				<span class="hljs-comment">// Let&#x27;s remove the old one and go with the new one.</span><br>				<span class="hljs-keyword">this</span>.configurationClasses.remove(configClass);<br>				<span class="hljs-keyword">for</span> (Iterator&lt;ConfigurationClass&gt; it = <span class="hljs-keyword">this</span>.knownSuperclasses.values().iterator(); it.hasNext();) &#123;<br>					<span class="hljs-keyword">if</span> (configClass.equals(it.next())) &#123;<br>						it.remove();<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">//递归处理配置类及其超类层次结构。</span><br>		SourceClass sourceClass = asSourceClass(configClass);<br>		<span class="hljs-keyword">do</span> &#123;<br>			sourceClass = doProcessConfigurationClass(configClass, sourceClass);<br>		&#125;<br>		<span class="hljs-keyword">while</span> (sourceClass != <span class="hljs-keyword">null</span>);<br><br>		<span class="hljs-keyword">this</span>.configurationClasses.put(configClass, configClass);<br>	&#125;<br>	<br>	<br>org.springframework.context.annotation.ConfigurationClassParser#doProcessConfigurationClass<br>	<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> SourceClass <span class="hljs-title">doProcessConfigurationClass</span><span class="hljs-params">(ConfigurationClass configClass, SourceClass sourceClass)</span></span><br><span class="hljs-function">			<span class="hljs-keyword">throws</span> IOException </span>&#123;<br><br>		<span class="hljs-comment">// Recursively process any member (nested) classes first</span><br>		processMemberClasses(configClass, sourceClass);<br><br>		<span class="hljs-comment">//处理@PropertySource注解</span><br>		<span class="hljs-keyword">for</span> (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(<br>				sourceClass.getMetadata(), PropertySources.class,<br>				org.springframework.context.annotation.PropertySource.class)) &#123;<br>			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.environment <span class="hljs-keyword">instanceof</span> ConfigurableEnvironment) &#123;<br>				processPropertySource(propertySource);<br>			&#125;<br>			<span class="hljs-keyword">else</span> &#123;<br>				logger.warn(<span class="hljs-string">&quot;Ignoring @PropertySource annotation on [&quot;</span> + sourceClass.getMetadata().getClassName() +<br>						<span class="hljs-string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span>);<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">//处理@ComponentScan注解</span><br>		<br>		<span class="hljs-comment">//解析@ComponentScans注解的属性 封装成一个一个的componentscan对象</span><br>		Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);<br>		<span class="hljs-keyword">if</span> (!componentScans.isEmpty() &amp;&amp;!<span class="hljs-keyword">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;<br>			<br>			<span class="hljs-comment">//循环componentScans的set</span><br>			<span class="hljs-keyword">for</span> (AnnotationAttributes componentScan : componentScans) &#123;<br>				<span class="hljs-comment">// 立即执行扫描解析</span><br>				Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =<span class="hljs-keyword">this</span>.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());<br>				<span class="hljs-comment">//检查任何其他配置类的扫描定义集，并在需要时递归解析</span><br>				<span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;<br>				    <span class="hljs-comment">//获取原始的bean定义信息</span><br>					BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();<br>					<span class="hljs-keyword">if</span> (bdCand == <span class="hljs-keyword">null</span>) &#123;<br>						bdCand = holder.getBeanDefinition();<br>					&#125;<br>					<span class="hljs-comment">//检查当前的bean定义信息是不是配置类  比如MainConfig的bean定义信息</span><br>					<span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, <span class="hljs-keyword">this</span>.metadataReaderFactory)) &#123;<br>					    <span class="hljs-comment">//递归调用来解析MainConfig,解析出来配置类的中导入的bean定义信息</span><br>						parse(bdCand.getBeanClassName(), holder.getBeanName());<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">//处理@Import注解   解析Import 注解的ImportSelector  ImportBeanDefinitionRegister,@Bean这种</span><br>		<span class="hljs-comment">//存放在ConfigClass中</span><br>		processImports(configClass, sourceClass, getImports(sourceClass), <span class="hljs-keyword">true</span>);<br><br>		<span class="hljs-comment">//处理 @ImportResource annotations</span><br>		<span class="hljs-keyword">if</span> (sourceClass.getMetadata().isAnnotated(ImportResource.class.getName())) &#123;<br>			AnnotationAttributes importResource =<br>					AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);<br>			String[] resources = importResource.getStringArray(<span class="hljs-string">&quot;locations&quot;</span>);<br>			Class&lt;? extends BeanDefinitionReader&gt; readerClass = importResource.getClass(<span class="hljs-string">&quot;reader&quot;</span>);<br>			<span class="hljs-keyword">for</span> (String resource : resources) &#123;<br>				String resolvedResource = <span class="hljs-keyword">this</span>.environment.resolveRequiredPlaceholders(resource);<br>				configClass.addImportedResource(resolvedResource, readerClass);<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// 处理  @Bean methods</span><br>		Set&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);<br>		<span class="hljs-keyword">for</span> (MethodMetadata methodMetadata : beanMethods) &#123;<br>			configClass.addBeanMethod(<span class="hljs-keyword">new</span> BeanMethod(methodMetadata, configClass));<br>		&#125;<br><br>		<span class="hljs-comment">//处理接口</span><br>		processInterfaces(configClass, sourceClass);<br><br>		<span class="hljs-comment">// 处理超类的</span><br>		<span class="hljs-keyword">if</span> (sourceClass.getMetadata().hasSuperClass()) &#123;<br>			String superclass = sourceClass.getMetadata().getSuperClassName();<br>			<span class="hljs-keyword">if</span> (!superclass.startsWith(<span class="hljs-string">&quot;java&quot;</span>) &amp;&amp; !<span class="hljs-keyword">this</span>.knownSuperclasses.containsKey(superclass)) &#123;<br>				<span class="hljs-keyword">this</span>.knownSuperclasses.put(superclass, configClass);<br>				<span class="hljs-comment">// Superclass found, return its annotation metadata and recurse</span><br>				<span class="hljs-keyword">return</span> sourceClass.getSuperClass();<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// No superclass -&gt; processing is complete</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>	&#125;<br>	<br><span class="hljs-comment">//通过组件扫描器进行真正的解析	</span><br>org.springframework.context.annotation.ComponentScanAnnotationParser#parse<br>Set&lt;BeanDefinitionHolder&gt;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title">parse</span><span class="hljs-params">(AnnotationAttributes componentScan, <span class="hljs-keyword">final</span> String declaringClass)</span> </span>&#123;<br>		Assert.state(<span class="hljs-keyword">this</span>.environment != <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;Environment must not be null&quot;</span>);<br>		Assert.state(<span class="hljs-keyword">this</span>.resourceLoader != <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;ResourceLoader must not be null&quot;</span>);<br>        <br>        <span class="hljs-comment">//创建一个类路径下的bean定义扫描器</span><br>		ClassPathBeanDefinitionScanner scanner = <span class="hljs-keyword">new</span> ClassPathBeanDefinitionScanner(<span class="hljs-keyword">this</span>.registry,<br>				componentScan.getBoolean(<span class="hljs-string">&quot;useDefaultFilters&quot;</span>), <span class="hljs-keyword">this</span>.environment, <span class="hljs-keyword">this</span>.resourceLoader);<br>        <br>        <span class="hljs-comment">//为扫描器设置一个bean 名称的生成器</span><br>		Class&lt;? extends BeanNameGenerator&gt; generatorClass = componentScan.getClass(<span class="hljs-string">&quot;nameGenerator&quot;</span>);<br>		<span class="hljs-keyword">boolean</span> useInheritedGenerator = (BeanNameGenerator.class == generatorClass);<br>		scanner.setBeanNameGenerator(useInheritedGenerator ? <span class="hljs-keyword">this</span>.beanNameGenerator :<br>				BeanUtils.instantiateClass(generatorClass));<br>        <br>        <br>		ScopedProxyMode scopedProxyMode = componentScan.getEnum(<span class="hljs-string">&quot;scopedProxy&quot;</span>);<br>		<span class="hljs-keyword">if</span> (scopedProxyMode != ScopedProxyMode.DEFAULT) &#123;<br>			scanner.setScopedProxyMode(scopedProxyMode);<br>		&#125;<br>		<span class="hljs-keyword">else</span> &#123;<br>			Class&lt;? extends ScopeMetadataResolver&gt; resolverClass = componentScan.getClass(<span class="hljs-string">&quot;scopeResolver&quot;</span>);<br>			scanner.setScopeMetadataResolver(BeanUtils.instantiateClass(resolverClass));<br>		&#125;<br><br>		scanner.setResourcePattern(componentScan.getString(<span class="hljs-string">&quot;resourcePattern&quot;</span>));<br><br>		<span class="hljs-keyword">for</span> (AnnotationAttributes filter : componentScan.getAnnotationArray(<span class="hljs-string">&quot;includeFilters&quot;</span>)) &#123;<br>			<span class="hljs-keyword">for</span> (TypeFilter typeFilter : typeFiltersFor(filter)) &#123;<br>				scanner.addIncludeFilter(typeFilter);<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">for</span> (AnnotationAttributes filter : componentScan.getAnnotationArray(<span class="hljs-string">&quot;excludeFilters&quot;</span>)) &#123;<br>			<span class="hljs-keyword">for</span> (TypeFilter typeFilter : typeFiltersFor(filter)) &#123;<br>				scanner.addExcludeFilter(typeFilter);<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-keyword">boolean</span> lazyInit = componentScan.getBoolean(<span class="hljs-string">&quot;lazyInit&quot;</span>);<br>		<span class="hljs-keyword">if</span> (lazyInit) &#123;<br>			scanner.getBeanDefinitionDefaults().setLazyInit(<span class="hljs-keyword">true</span>);<br>		&#125;<br><br>		Set&lt;String&gt; basePackages = <span class="hljs-keyword">new</span> LinkedHashSet&lt;String&gt;();<br>		String[] basePackagesArray = componentScan.getStringArray(<span class="hljs-string">&quot;basePackages&quot;</span>);<br>		<span class="hljs-keyword">for</span> (String pkg : basePackagesArray) &#123;<br>			String[] tokenized = StringUtils.tokenizeToStringArray(<span class="hljs-keyword">this</span>.environment.resolvePlaceholders(pkg),<br>					ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);<br>			basePackages.addAll(Arrays.asList(tokenized));<br>		&#125;<br>		<span class="hljs-keyword">for</span> (Class&lt;?&gt; clazz : componentScan.getClassArray(<span class="hljs-string">&quot;basePackageClasses&quot;</span>)) &#123;<br>			basePackages.add(ClassUtils.getPackageName(clazz));<br>		&#125;<br>		<span class="hljs-keyword">if</span> (basePackages.isEmpty()) &#123;<br>			basePackages.add(ClassUtils.getPackageName(declaringClass));<br>		&#125;<br><br>		scanner.addExcludeFilter(<span class="hljs-keyword">new</span> AbstractTypeHierarchyTraversingFilter(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>) &#123;<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">matchClassName</span><span class="hljs-params">(String className)</span> </span>&#123;<br>				<span class="hljs-keyword">return</span> declaringClass.equals(className);<br>			&#125;<br>		&#125;);<br>		<span class="hljs-comment">//真正扫描器扫描指定路径</span><br>		<span class="hljs-keyword">return</span> scanner.doScan(StringUtils.toStringArray(basePackages));<br>	&#125;<br><br><br><span class="hljs-comment">//创建类路径下的bean定义扫描器</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClassPathBeanDefinitionScanner</span><span class="hljs-params">(BeanDefinitionRegistry registry, <span class="hljs-keyword">boolean</span> useDefaultFilters,</span></span><br><span class="hljs-function"><span class="hljs-params">			Environment environment, ResourceLoader resourceLoader)</span> </span>&#123;<br><br>		Assert.notNull(registry, <span class="hljs-string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);<br>		<span class="hljs-keyword">this</span>.registry = registry;<br>        <br>        <span class="hljs-comment">//使用默认的扫描规则</span><br>		<span class="hljs-keyword">if</span> (useDefaultFilters) &#123;<br>			registerDefaultFilters();<br>		&#125;<br>		<span class="hljs-comment">//设置环境变量</span><br>		setEnvironment(environment);<br>		<span class="hljs-comment">//设置资源加载器</span><br>		setResourceLoader(resourceLoader);<br>	&#125;<br>	<br>	<span class="hljs-comment">//默认的扫描规则</span><br>	<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerDefaultFilters</span><span class="hljs-params">()</span> </span>&#123;<br>	    <span class="hljs-comment">//添加了Componet的解析，这就是我们为啥@Componet @Respository @Service @Controller的  @AspectJ</span><br>		<span class="hljs-keyword">this</span>.includeFilters.add(<span class="hljs-keyword">new</span> AnnotationTypeFilter(Component.class));<br>		ClassLoader cl = ClassPathScanningCandidateComponentProvider.class.getClassLoader();<br>		<span class="hljs-keyword">try</span> &#123;<br>		    <span class="hljs-comment">//添加Jsr 250规范的注解</span><br>			<span class="hljs-keyword">this</span>.includeFilters.add(<span class="hljs-keyword">new</span> AnnotationTypeFilter(<br>					((Class&lt;? extends Annotation&gt;) ClassUtils.forName(<span class="hljs-string">&quot;javax.annotation.ManagedBean&quot;</span>, cl)), <span class="hljs-keyword">false</span>));<br>			logger.debug(<span class="hljs-string">&quot;JSR-250 &#x27;javax.annotation.ManagedBean&#x27; found and supported for component scanning&quot;</span>);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br>			<span class="hljs-comment">// JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.</span><br>		&#125;<br>		<span class="hljs-keyword">try</span> &#123;<br>		    <span class="hljs-comment">//JSR330的注解</span><br>			<span class="hljs-keyword">this</span>.includeFilters.add(<span class="hljs-keyword">new</span> AnnotationTypeFilter(<br>					((Class&lt;? extends Annotation&gt;) ClassUtils.forName(<span class="hljs-string">&quot;javax.inject.Named&quot;</span>, cl)), <span class="hljs-keyword">false</span>));<br>			logger.debug(<span class="hljs-string">&quot;JSR-330 &#x27;javax.inject.Named&#x27; annotation found and supported for component scanning&quot;</span>);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (ClassNotFoundException ex) &#123;<br>			<span class="hljs-comment">// JSR-330 API not available - simply skip.</span><br>		&#125;<br>	&#125;<br>	<br>	<span class="hljs-comment">//使用扫描器去真正的扫描类,返回Set&lt;BeanDefinitionHolder&gt;</span><br>	org.springframework.context.annotation.ClassPathBeanDefinitionScanner#doScan<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">protected</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title">doScan</span><span class="hljs-params">(String... basePackages)</span> </span>&#123;<br>		Assert.notEmpty(basePackages, <span class="hljs-string">&quot;At least one base package must be specified&quot;</span>);<br>		<span class="hljs-comment">//创建一个Bean定义 holder的 set</span><br>		Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="hljs-keyword">new</span> LinkedHashSet&lt;BeanDefinitionHolder&gt;();<br>		<span class="hljs-comment">//循环扫描路径</span><br>		<span class="hljs-keyword">for</span> (String basePackage : basePackages) &#123;<br>		    <span class="hljs-comment">//找到候选的组件集合</span><br>			Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage);<br>			<span class="hljs-comment">//循环候选组件集合</span><br>			<span class="hljs-keyword">for</span> (BeanDefinition candidate : candidates) &#123;<br>				ScopeMetadata scopeMetadata = <span class="hljs-keyword">this</span>.scopeMetadataResolver.resolveScopeMetadata(candidate);<br>				candidate.setScope(scopeMetadata.getScopeName());<br>				<span class="hljs-comment">//生成bean的名称</span><br>				String beanName = <span class="hljs-keyword">this</span>.beanNameGenerator.generateBeanName(candidate, <span class="hljs-keyword">this</span>.registry);<br>				<span class="hljs-comment">//判断是不是抽象的beand定义</span><br>				<span class="hljs-keyword">if</span> (candidate <span class="hljs-keyword">instanceof</span> AbstractBeanDefinition) &#123;<br>					postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName);<br>				&#125;<br>				<span class="hljs-comment">//注解的bean定义西悉尼</span><br>				<span class="hljs-keyword">if</span> (candidate <span class="hljs-keyword">instanceof</span> AnnotatedBeanDefinition) &#123;<br>					AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition) candidate);<br>				&#125;<br>				<br>				<span class="hljs-keyword">if</span> (checkCandidate(beanName, candidate)) &#123; <span class="hljs-comment">//检查当前的和存主的bean定义是否有冲突</span><br>				    <span class="hljs-comment">//把候选的组件封装成BeanDefinitionHolder</span><br>					BeanDefinitionHolder definitionHolder = <span class="hljs-keyword">new</span> BeanDefinitionHolder(candidate, beanName);<br>					definitionHolder =AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="hljs-keyword">this</span>.registry);<br>					<span class="hljs-comment">//加入到bean定义的集合中</span><br>					beanDefinitions.add(definitionHolder);<br>					<span class="hljs-comment">//注册当前的bean定义信息</span><br>					registerBeanDefinition(definitionHolder, <span class="hljs-keyword">this</span>.registry);<br>				&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">return</span> beanDefinitions;<br>	&#125;<br><br>    <br>org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider#findCandidateComponents <br>    <span class="hljs-comment">//找到候选的组件 返回Set&lt;BeanDefinition&gt;的集合</span><br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Set&lt;BeanDefinition&gt; <span class="hljs-title">findCandidateComponents</span><span class="hljs-params">(String basePackage)</span> </span>&#123;<br>		<span class="hljs-comment">//候选的bean定义信息</span><br>		Set&lt;BeanDefinition&gt; candidates = <span class="hljs-keyword">new</span> LinkedHashSet&lt;BeanDefinition&gt;();<br>		<span class="hljs-keyword">try</span> &#123;<br>		    <span class="hljs-comment">//拼接需要扫描包下面的类的路径   classpath*:com/tuling/testapplicationlistener/**/*.class</span><br>			String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +<br>					resolveBasePackage(basePackage) + <span class="hljs-string">&#x27;/&#x27;</span> + <span class="hljs-keyword">this</span>.resourcePattern;<br>			<span class="hljs-comment">//把路径解析成一个个.class文件		</span><br>			Resource[] resources = <span class="hljs-keyword">this</span>.resourcePatternResolver.getResources(packageSearchPath);<br>			<span class="hljs-keyword">boolean</span> traceEnabled = logger.isTraceEnabled();<br>			<span class="hljs-keyword">boolean</span> debugEnabled = logger.isDebugEnabled();<br>			<br>			<span class="hljs-comment">//循环.class文件的resource对象</span><br>			<span class="hljs-keyword">for</span> (Resource resource : resources) &#123;<br>				<span class="hljs-keyword">if</span> (traceEnabled) &#123;<br>					logger.trace(<span class="hljs-string">&quot;Scanning &quot;</span> + resource);<br>				&#125;<br>				<span class="hljs-comment">//判断class文件是否可读</span><br>				<span class="hljs-keyword">if</span> (resource.isReadable()) &#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>					    <span class="hljs-comment">//把resource对象 变为一个类的原信息读取器</span><br>						MetadataReader metadataReader = <span class="hljs-keyword">this</span>.metadataReaderFactory.getMetadataReader(resource);<br>						<span class="hljs-comment">//判断类的源信息读取器是否为候选的组件</span><br>						<span class="hljs-keyword">if</span> (isCandidateComponent(metadataReader)) &#123;  <span class="hljs-comment">//是候选的组件</span><br>						    <span class="hljs-comment">//把类元信息读取器封装成一个ScannedGenericBeanDefinition</span><br>							ScannedGenericBeanDefinition sbd = <span class="hljs-keyword">new</span> ScannedGenericBeanDefinition(metadataReader);<br>							sbd.setResource(resource);<br>							sbd.setSource(resource);<br>							<span class="hljs-comment">//是候选的组件</span><br>							<span class="hljs-keyword">if</span> (isCandidateComponent(sbd)) &#123;<br>								<span class="hljs-keyword">if</span> (debugEnabled) &#123;<br>									logger.debug(<span class="hljs-string">&quot;Identified candidate component class: &quot;</span> + resource);<br>								&#125;<br>								<span class="hljs-comment">//把当前解析出来的定义的加入到 BeanDefinition的集合中</span><br>								candidates.add(sbd);<br>							&#125;<br>							<span class="hljs-keyword">else</span> &#123;<br>								<span class="hljs-keyword">if</span> (debugEnabled) &#123;<br>									logger.debug(<span class="hljs-string">&quot;Ignored because not a concrete top-level class: &quot;</span> + resource);<br>								&#125;<br>							&#125;<br>						&#125;<br>						<span class="hljs-keyword">else</span> &#123;<br>							<span class="hljs-keyword">if</span> (traceEnabled) &#123;<br>								logger.trace(<span class="hljs-string">&quot;Ignored because not matching any filter: &quot;</span> + resource);<br>							&#125;<br>						&#125;<br>					&#125;<br>					<span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(<br>								<span class="hljs-string">&quot;Failed to read candidate component class: &quot;</span> + resource, ex);<br>					&#125;<br>				&#125;<br>				<span class="hljs-keyword">else</span> &#123;<br>					<span class="hljs-keyword">if</span> (traceEnabled) &#123;<br>						logger.trace(<span class="hljs-string">&quot;Ignored because not readable: &quot;</span> + resource);<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(<span class="hljs-string">&quot;I/O failure during classpath scanning&quot;</span>, ex);<br>		&#125;<br>		<span class="hljs-keyword">return</span> candidates;<br>	&#125;	<br><br><span class="hljs-comment">//是不是需要扫描的组件	</span><br>org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider#isCandidateComponent<br>	<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isCandidateComponent</span><span class="hljs-params">(MetadataReader metadataReader)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>		<span class="hljs-comment">//是不是被排除的</span><br>		<span class="hljs-keyword">for</span> (TypeFilter tf : <span class="hljs-keyword">this</span>.excludeFilters) &#123;<br>			<span class="hljs-keyword">if</span> (tf.match(metadataReader, <span class="hljs-keyword">this</span>.metadataReaderFactory)) &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">//在被包含的组件</span><br>		<span class="hljs-keyword">for</span> (TypeFilter tf : <span class="hljs-keyword">this</span>.includeFilters) &#123;<br>			<span class="hljs-keyword">if</span> (tf.match(metadataReader, <span class="hljs-keyword">this</span>.metadataReaderFactory)) &#123;<br>				<span class="hljs-keyword">return</span> isConditionMatch(metadataReader);<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>	&#125;	<br>	<br>	<span class="hljs-comment">//是否能够进行@Conditional判断</span><br>    org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider#isConditionMatch<br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isConditionMatch</span><span class="hljs-params">(MetadataReader metadataReader)</span> </span>&#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.conditionEvaluator == <span class="hljs-keyword">null</span>) &#123;<br>			<span class="hljs-keyword">this</span>.conditionEvaluator = <span class="hljs-keyword">new</span> ConditionEvaluator(getRegistry(), getEnvironment(), getResourceLoader());<br>		&#125;<br>		<span class="hljs-keyword">return</span> !<span class="hljs-keyword">this</span>.conditionEvaluator.shouldSkip(metadataReader.getAnnotationMetadata());<br>	&#125;	<br>	<br></code></pre></td></tr></table></figure>

<h1 id="BeanDefinition加载过程"><a href="#BeanDefinition加载过程" class="headerlink" title="BeanDefinition加载过程"></a>BeanDefinition加载过程</h1><p>概述：</p>
<p>1、new AnnotationConfigApplicationContext时注入了实现priority接口的BeanDefinitionRegistryPostProcessor的工厂bean定义注册后置处理器：ConfigurationClassPostProcessor</p>
<p>2、invokeBeanFactoryPostProcessors(beanFactory); 执行时扫描到ConfigurationClassPostProcessor</p>
<p>且调用执行</p>
<p>3、ConfigurationClassPostProcessor.postProcessBeanDefinitionRegistry的作用是</p>
<ol>
<li>识别我们传入的标有@Configuration的类</li>
<li>创建ConfigurationClassParser</li>
<li>解析配置类<ol>
<li>@ComponentScan</li>
<li>@Import</li>
<li>Bean</li>
<li>@PropertySource</li>
<li>@ImportResource</li>
<li>处理其他的</li>
</ol>
</li>
</ol>
<p><img src="/images/Spring02-%E6%89%AB%E6%8F%8Fbean%E5%AE%9A%E4%B9%89%E7%9A%84%E8%BF%87%E7%A8%8B/BeanDefinition%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B.png">  </p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%BA%90%E7%A0%81/" rel="tag"># 源码</a>
              <a href="/tags/Spring/" rel="tag"># Spring</a>
              <a href="/tags/bean%E5%AE%9A%E4%B9%89%E4%BF%A1%E6%81%AF/" rel="tag"># bean定义信息</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/06/14/Spring-01-%E5%B7%A5%E5%8E%82%E7%B1%BB%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3/" rel="prev" title="Spring-01-工厂类与常用注解">
      <i class="fa fa-chevron-left"></i> Spring-01-工厂类与常用注解
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/06/20/Spring03-%E5%AE%B9%E5%99%A8%E5%88%9B%E5%BB%BAbean%E7%9A%84%E8%BF%87%E7%A8%8B/" rel="next" title="Spring03-容器创建bean的过程.">
      Spring03-容器创建bean的过程. <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%B2%E5%89%8D%E6%8B%93%E5%B1%95"><span class="nav-number">1.</span> <span class="nav-text">讲前拓展</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E6%9C%BA%E5%88%B6"><span class="nav-number">1.1.</span> <span class="nav-text">事件监听机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BeanFactoryPostProcessor"><span class="nav-number">1.2.</span> <span class="nav-text">BeanFactoryPostProcessor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#i4%E6%A0%87%E8%AE%B0%E5%A4%84%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number">1.2.1.</span> <span class="nav-text">i4标记处源码解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#i5%E6%A0%87%E8%AE%B0%E5%A4%84%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number">1.2.2.</span> <span class="nav-text">i5标记处源码解析:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#i6%E6%A0%87%E8%AE%B0%E5%A4%84%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number">1.2.3.</span> <span class="nav-text">i6标记处源码解析 :</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#BeanDefinition%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">BeanDefinition加载过程</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="24khandsome"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">24khandsome</p>
  <div class="site-description" itemprop="description">24khandsome's Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">91</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">83</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">24khandsome</span>
  
	<br/>
	<span id="busuanzi_container_site_pv">
		<span class="post-meta-item-icon">
			<i class="fa fa-user"></i>
		</span>
		访问量：<span id="busuanzi_value_site_pv"></span> 次数
	</span>

	<span class="post-meta-divider">|</span>
		<span id="busuanzi_container_site_uv">
			<i class="fa fa-eye"></i>
			访客数：<span id="busuanzi_value_site_uv"></span> 人次
	</span>

</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
<!-- 动态背景 -->
<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


</html>
